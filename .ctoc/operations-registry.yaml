# ═══════════════════════════════════════════════════════════════════════════════
#  CTOC Operations Registry v2.0.0
#  Single source of truth for all agents, Iron Loop, and quality matrix
# ═══════════════════════════════════════════════════════════════════════════════

schema_version: "2.0.0"
updated: "2026-01-28"

# ═══════════════════════════════════════════════════════════════════════════════
#  Core Principles
# ═══════════════════════════════════════════════════════════════════════════════
#
#  1. NEVER block humans - Agents advise only, never prevent user actions
#  2. Claude Code IS the runtime - No separate runtime needed
#  3. Quality over speed - Accuracy over latency
#  4. Self-improvement - Every run can trigger learning
#  5. Everything is an agent - Tiered by complexity
#
# ═══════════════════════════════════════════════════════════════════════════════

# Token budget for Claude Code context
token_budget:
  per_step: 50000
  reserved_for_user: 10000
  available_for_agents: 40000

# Model configuration
models:
  default: haiku           # Minimum model (configurable in settings)
  fallback_chain: [opus, sonnet, haiku]

# ═══════════════════════════════════════════════════════════════════════════════
#  AGENTS
# ═══════════════════════════════════════════════════════════════════════════════

agents:
  # ─────────────────────────────────────────────────────────────────────────────
  #  COORDINATOR
  # ─────────────────────────────────────────────────────────────────────────────

  cto-chief:
    path: agents/coordinator/cto-chief.md
    model: opus
    category: coordinator
    description: Central coordinator, learning aggregator, decision maker
    steps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
    always_available: true

  # ─────────────────────────────────────────────────────────────────────────────
  #  PLANNING AGENTS (Steps 1-6)
  # ─────────────────────────────────────────────────────────────────────────────

  functional-planner:
    path: agents/planning/functional-planner.md
    model: opus
    category: planning
    description: Creates functional plans (steps 1-3)
    steps: [1, 2, 3]

  functional-reviewer:
    path: agents/planning/functional-reviewer.md
    model: opus
    category: planning
    description: Reviews functional plans, approves or returns for revision
    steps: [3]
    review_gate: true
    on_reject: goto_step_1

  impl-planner:
    path: agents/planning/impl-planner.md
    model: opus
    category: planning
    description: Creates implementation plans (steps 4-6)
    steps: [4, 5, 6]

  impl-plan-reviewer:
    path: agents/planning/impl-plan-reviewer.md
    model: opus
    category: planning
    description: Reviews implementation plans
    steps: [6]
    review_gate: true
    on_reject: goto_step_4

  iron-loop-integrator:
    path: agents/planning/iron-loop-integrator.md
    model: sonnet
    category: planning
    description: Injects Iron Loop steps 7-15 into implementation plan
    steps: [6]

  # ─────────────────────────────────────────────────────────────────────────────
  #  IMPLEMENTATION AGENTS (Steps 7-15)
  # ─────────────────────────────────────────────────────────────────────────────

  test-maker:
    path: agents/implementation/test-maker.md
    model: opus
    category: implementation
    description: Writes tests first (TDD Red)
    steps: [7]

  quality-checker:
    path: agents/implementation/quality-checker.md
    model: sonnet
    category: implementation
    description: Lint, format, type-check
    steps: [8, 10]

  implementer:
    path: agents/implementation/implementer.md
    model: sonnet
    category: implementation
    description: Setup + Core code + Error handling
    steps: [9]
    sub_tasks:
      - setup_environment
      - core_implementation
      - error_handling

  self-reviewer:
    path: agents/implementation/self-reviewer.md
    model: opus
    category: implementation
    description: Self-review, calls quality-checker
    steps: [10]
    invokes: [quality-checker]
    tdd_loop: true  # Can loop back to step 7

  optimizer:
    path: agents/implementation/optimizer.md
    model: sonnet
    category: implementation
    description: Performance improvements
    steps: [11]

  security-scanner:
    path: agents/implementation/security-scanner.md
    model: opus
    category: implementation
    description: Security vulnerability check
    steps: [12]

  verifier:
    path: agents/implementation/verifier.md
    model: sonnet
    category: implementation
    description: Run ALL tests (unit + integration)
    steps: [13]

  documenter:
    path: agents/implementation/documenter.md
    model: sonnet
    category: implementation
    description: Update documentation
    steps: [14]

  impl-reviewer:
    path: agents/implementation/impl-reviewer.md
    model: opus
    category: implementation
    description: Final review of steps 7-14, can loop back, commits when satisfied
    steps: [15]
    review_gate: true
    smart_rerun: true  # Decides which steps need re-running based on change impact
    can_loop_to: [7, 8, 9, 10, 11, 12, 13, 14]
    highest_standards: true  # Checks all 14 quality dimensions

  # ─────────────────────────────────────────────────────────────────────────────
  #  WRITING AGENTS (Document Creation)
  # ─────────────────────────────────────────────────────────────────────────────

  document-planner:
    path: agents/writing/document-planner.md
    model: haiku
    category: writing
    description: Fast document structure planning for rapid iteration
    always_available: true
    dependencies:
      python: []  # No deps for planning

  pdf-writer:
    path: agents/writing/pdf-writer.md
    model: sonnet
    category: writing
    description: Create professional PDF documents
    dependencies:
      python: [fpdf2, reportlab, Pillow]
    auto_install: true

  docx-writer:
    path: agents/writing/docx-writer.md
    model: sonnet
    category: writing
    description: Create Microsoft Word documents
    dependencies:
      python: [python-docx, Pillow]
    auto_install: true

  pptx-writer:
    path: agents/writing/pptx-writer.md
    model: sonnet
    category: writing
    description: Create PowerPoint presentations
    dependencies:
      python: [python-pptx, Pillow]
    auto_install: true

  document-reader:
    path: agents/writing/document-reader.md
    model: sonnet
    category: writing
    description: Read and extract content from PDF, DOCX, PPTX files
    dependencies:
      python: [PyPDF2, pdfplumber, python-docx, python-pptx, Pillow]
    auto_install: true

# ═══════════════════════════════════════════════════════════════════════════════
#  IRON LOOP v2.0
# ═══════════════════════════════════════════════════════════════════════════════

iron_loop:
  version: "2.0"

  planning_phase:
    - step: 1
      name: ASSESS
      description: Problem understanding
      agents: [cto-chief, functional-planner]
    - step: 2
      name: ALIGN
      description: User goals & business objectives
      agents: [functional-planner]
    - step: 3
      name: CAPTURE
      description: Requirements & success criteria
      agents: [functional-planner, functional-reviewer]
      review_gate: functional-reviewer
    - step: 4
      name: PLAN
      description: Technical approach
      agents: [impl-planner]
    - step: 5
      name: DESIGN
      description: Architecture design
      agents: [impl-planner]
    - step: 6
      name: SPEC
      description: Detailed specifications
      agents: [impl-planner, impl-plan-reviewer, iron-loop-integrator]
      review_gate: impl-plan-reviewer

  implementation_phase:
    - step: 7
      name: TEST
      description: Write tests first (TDD Red)
      agents: [test-maker]
    - step: 8
      name: QUALITY
      description: Lint, format, type-check
      agents: [quality-checker]
    - step: 9
      name: IMPLEMENT
      description: Setup + Core code + Error handling
      agents: [implementer]
    - step: 10
      name: REVIEW
      description: Self-review + re-run quality
      agents: [self-reviewer, quality-checker]
      tdd_loop: true  # Can loop back to step 7
    - step: 11
      name: OPTIMIZE
      description: Performance improvements
      agents: [optimizer]
    - step: 12
      name: SECURE
      description: Security vulnerability check
      agents: [security-scanner]
    - step: 13
      name: VERIFY
      description: Run ALL tests (unit + integration)
      agents: [verifier]
    - step: 14
      name: DOCUMENT
      description: Update documentation
      agents: [documenter]
    - step: 15
      name: FINAL-REVIEW
      description: Reviews 7-14 with highest standards, can loop back, commits when satisfied
      agents: [impl-reviewer]
      review_gate: impl-reviewer
      can_loop_to: [7, 8, 9, 10, 11, 12, 13, 14]

# ═══════════════════════════════════════════════════════════════════════════════
#  QUALITY MATRIX (14 Dimensions - ISO 25010 aligned)
# ═══════════════════════════════════════════════════════════════════════════════

quality_matrix:
  # Default threshold (1.0 = perfect)
  threshold: 1.0

  dimensions:
    correctness:
      - tests_cover_requirements
      - edge_cases_tested
      - negative_cases_tested
      - tests_are_meaningful
      - business_logic_verified

    completeness:
      - all_acceptance_criteria_met
      - implicit_requirements_identified
      - error_messages_user_friendly
      - logging_adequate

    maintainability:
      - follows_project_patterns
      - no_code_smells
      - no_duplication
      - readable_by_junior
      - single_responsibility
      - testability_high

    security:
      - owasp_top_10_checked
      - input_validation
      - output_encoding
      - secrets_not_hardcoded
      - authentication_verified
      - authorization_verified

    performance:
      - no_n_plus_1_queries
      - no_unbounded_operations
      - caching_where_appropriate
      - response_time_acceptable

    reliability:
      - errors_handled_gracefully
      - retries_with_backoff
      - circuit_breakers_where_needed
      - timeouts_configured
      - fallbacks_defined

    compatibility:
      - api_backwards_compatible
      - data_format_standard
      - integrations_tested

    usability:
      - error_messages_helpful
      - output_clear
      - documentation_complete

    portability:
      - no_hardcoded_paths
      - environment_configurable
      - platform_independent

    testing:
      coverage_minimum: 90
      checks:
        - unit_tests_exist
        - integration_tests_exist
        - happy_path_tested
        - error_path_tested
        - test_isolation

    accessibility:
      default_enabled: true  # For frontend projects
      configurable: true
      checks:
        - wcag_2_2_compliant
        - keyboard_navigable
        - screen_reader_compatible
        - color_contrast_adequate

    observability:
      checks:
        - structured_logging
        - metrics_exposed
        - health_endpoints
        - alerting_configured

    safety:
      checks:
        - no_harm_to_users
        - graceful_degradation
        - data_loss_prevention
        - human_oversight_possible

    ethics_ai:
      auto_enable_for: ai_projects
      checks:
        - bias_tested
        - fairness_verified
        - explainability
        - human_in_loop
        - data_consent
        - privacy_preserved

# ═══════════════════════════════════════════════════════════════════════════════
#  LEARNING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

learning:
  enabled: true
  directory: .ctoc/learnings  # Per-project, git-tracked
  interaction_level: high     # Discuss all learnings with user

  stages:
    pending: pending
    approved: approved
    applied: applied
    rejected: rejected

  confidence:
    dynamic: true             # Updates on success/failure
    initial_default: 0.7
    success_increment: 0.02
    failure_decrement: 0.05

  re_evaluation:
    scheduled: 3_months       # Every 3 months
    on_conflict: true
    user_triggered: true
    use_websearch: true

  conflict_resolution:
    method: user_decides
    show_pros_cons: true

  export:
    command: "ctoc learning export"
    to_global: true           # Can transfer to Claude /memory

# ═══════════════════════════════════════════════════════════════════════════════
#  CODEBASE INDEX
# ═══════════════════════════════════════════════════════════════════════════════

codebase_index:
  location:
    yaml: .ctoc/cache/codebase-index.yaml
    json: .ctoc/cache/codebase-index.json  # Optimized cache

  tiered_scanning:
    under_100_files: full_scan
    100_to_1000_files: quick_plus_hot_path_then_deep_background
    over_1000_files: quick_plus_hot_path_ask_for_deep

  structure:
    - entry_points
    - packages
    - concepts
    - dependencies
    - patterns

  sync:
    on_file_change: incremental
    on_commit: verify
    checksum_mismatch: rebuild_affected

# ═══════════════════════════════════════════════════════════════════════════════
#  ERROR HANDLING
# ═══════════════════════════════════════════════════════════════════════════════

error_handling:
  agent_failure:
    action: retry_with_backoff
    max_retries: 3
    backoff: [1s, 5s, 15s]

  api_unavailable:
    action: queue_and_wait
    notify_user: true

  invalid_settings:
    action: interactive_fix
    prompt_user: true

# ═══════════════════════════════════════════════════════════════════════════════
#  /ctoc SKILL COMMANDS
# ═══════════════════════════════════════════════════════════════════════════════

skill_commands:
  ctoc:
    description: "CTOC command interface"
    subcommands:
      - name: status
        aliases: [""]  # Default when just /ctoc
        description: Show CTOC status and available commands
      - name: plan
        subcommands:
          - new
          - propose
          - approve
          - start
          - implement
          - complete
          - status
          - list
      - name: progress
        aliases: [dashboard]
        description: Show Iron Loop progress
      - name: admin
        description: Terminal-based admin dashboard
        subcommands:
          - kanban     # Show kanban board
          - agents     # Manage agents
          - learnings  # Manage learnings
          - stats      # Show statistics
          - health     # System health check
      - name: doctor
        description: Check installation health
      - name: config
        subcommands:
          - show
          - set
          - edit
          - validate
      - name: learning
        subcommands:
          - list       # List local learnings
          - review     # Review pending learnings
          - suggest    # Submit learning to GitHub (for regular users)
          - export     # Export learnings
